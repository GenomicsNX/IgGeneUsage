---
title: "How to use IgGeneUsage"
author: "SK"
date: "June 25, 2019"
output: 
  html_document: 
    highlight: tango
    theme: journal
    toc: yes
---


```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = FALSE, 
                      warning = FALSE, message = FALSE)
```



```{r}
require(ggplot2)
require(gridExtra)
require(ggrepel)
require(rstan)
require(tidyr)
require(reshape2)
rstan_options(auto_write = TRUE)

source(file = "R/Util.R")
source(file = "R/Usage.R")
```





# Introduction
Decoding the properties of the immune repertoires is key in understanding the 
response of adaptive immunity during health challenges such as infection or 
disease. One important feature of all repertoires is their gene usage, i.e. the 
frequency at which the various germline genes have been rearranged to generate 
diverse B and T cell receptors (BCRs and TCRs).

If we discover a disruption in gene usage under a specific biological condition 
compared to a control, we can use this as hint about the potential link between 
that condition (disease, virus, etc.) and the immune mechanisms that for BCR/TCR 
generation and rearrangement, including subsequent selection pressures. 

The first step is, however, to detect differential gene usage between two 
biological conditions (e.g. healthy vs tumor). IgGeneUsage can help you do that.


## Usage
All you need to carry out your analysis with IgGeneUsage is a data.frame with 
the following 4 columns:

  1. sample_id: character identifier of the sample/repertoire (e.g. Patient-1)
  2. condition: character identifier of the condition to which each repertoire 
  belongs (e.g. healthy or tumor)
  3. gene_name: specific gene name (e.g. IGHV1-10 or family TRVB1)
  4. gene_usage_count: numeric (count) of rearrangements related to columns 1-3

Important remark: The sum of the gene_usage_count (column 4) for a given sample 
(sample_id) should be equal to the total number of rearrangements in that 
repertoire. 
The remaining parameters provided to IgGeneUsage help the MCMC sampler. The
default settings should suffice for most analyses.



# Case Studies
## Case Study I
The IgGeneUsage package comes with built-in datasets of gene usage. In the first 
case study we will evaluate disruptions in the IGHV-segment usage of class 
switched (CS) memory B-cells between HCV+ (N = 22) and healthy individuals 
(N = 7)[^1].

[^1]: Tucci, Felicia A., et al. "Biased IGH VDJ gene repertoire and clonal 
expansions in B cells of chronically hepatitis C virusâ€“infected individuals." 
Blood 131.5 (2018): 546-557.]


### Input data

```{r}
data("IGHV_HCV")

head(IGHV_HCV)
```


### Data visualization
Lets look at the input data with ggplot2.

```{r, fig.width=10, fig.height=4}
# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition, 
                         FUN = sum, data = IGHV_HCV)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = IGHV_HCV, y = total.usage, 
                  by = c("sample_id", "condition"), 
                  all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100


# visualize
ggplot(data = viz)+
  geom_point(aes(x = gene_name, y = gene_usage_pct, 
                 fill = condition, shape = condition),
             position = position_dodge(width = .7), stroke = 0)+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```


### Analysis with IgGeneUsage
This is the main method of IgGeneUsage for differential gene usage.

```{r}
# M <- diffUsage(usage.data = IGHV_HCV,
#                mcmc.warmup = 1000,
#                mcmc.steps = 2500,
#                mcmc.chains = 4,
#                mcmc.cores = 4,
#                hdi.level = 0.95,
#                adapt.delta = 0.95,
#                max.treedepth = 13,
#                dev.model = "src/stan_files/beta_binomial_model.stan")
# save(M, file = "R/dev/saved_temp/M_IGHV_HCV.RData")
M <- get(load(file = "R/dev/ighv_hcv_zibb_model.RData"))
```




### Model checking
Do not blindly trust the model $\rightarrow$ check it extensively. 

  * Checklist of successful MCMC sampling[^2]:
      * no divergences
      * no additional warnings from rstan
      * Rhat < 1.05 (see object glm.stats)
      * sufficiently high Neff
  * Checklist for valid model:
      * posterior predictive check reveal decent predictive accuracy on 
        already observed data (and also new data)
      * leave-one-out analysis with R-package loo (most k values should be low)

[^2]: https://mc-stan.org/misc/warnings.html

#### Checking MCMC sampling

  * divergences, tree-depth, energy
  
```{r}
rstan::check_hmc_diagnostics(M$glm)
```

  * Rhat and Neff

```{r, fig.width=7, fig.height=3}
grid.arrange(rstan::stan_rhat(object = M$glm),
             rstan::stan_ess(object = M$glm),
             nrow = 1)
```


#### Repertoire-specific PPC

  * IgGeneUsage performs automatic posterior predictive check (PPC).
  * In the following figure, we show the predictions (y-axis) of the model for 
  the usage of each gene (shown as point) in a given repertoire. The predictions 
  are compared against the observed data (x-axis).
  * If the point lies on the the diagnoal $\rightarrow$ accurate prediction.

```{r, fig.height=8, fig.width=8}
ggplot(data = M$ppc)+
  facet_wrap(facets = ~sample_id, ncol = 6)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw, y = ppc.raw.mean, ymin = ppc.raw.L, ymax = ppc.raw.H))+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()+
  xlab(label = "Observed usage [counts]")+
  ylab(label = "Predicted usage [counts]")
```




#### Gene-specific PPC

  * IgGeneUsage performs automatic posterior predictive check (PPC) at level of 
  genes as well, i.e. , predicts the overal (pooled) usage of a gene within each 
  condition.
  * Legend:
      * x-axis: mean usage of repertoires with given condition
      * y-axis: predicted usage (with 95% HDI)
  * If the point lies on the the diagnoal $\rightarrow$ accurate prediction.
  * In the previous plot, the usage data and the predictions consist counts. In 
  this plot, the usage is shown as % usage.

```{r, fig.width=3, fig.height=3}
ggplot(data = M$group.ppc$group.ppc)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
  geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  xlab(label = "Observed usage [%]")+
  ylab(label = "Predicted usage [%]")
```



#### Leave-one-out based comparison
  * with R-package loo
  
```{r}
loo::loo(x = loo::extract_log_lik(stanfit = M$glm))
```


### Results
This is the main result of IgGeneUsage $\rightarrow$ disruption effects on each
gene due to the biological condition. Legend:

  * Y-axis: all genes
  * X-axis: effect (positive = increase in usage in HCV, negative = decrease)
  * dashed-line: null effect
  * points: mean estimated effect
  * confidence intervals: 95% highest density interval (HDI) of effect

For simple interpretation of the results, we can color differently the effects 
based on whether they include/exclude the null-effect within their 95% HDI.

```{r, fig.height=8, fig.width=5}
# format data
stats <- M$glm.summary
stats$effect_col <- ifelse(test = stats$effect_L <= 0 & stats$effect_H >= 0,
                           yes = "include", no = "exclude")
stats <- stats[order(abs(stats$effect_mean), decreasing = F), ]
stats$gene_fac <- factor(x = stats$gene_name, 
                         levels = stats$gene_name)

stats <- merge(x= stats, y = M$test.stats, by = "gene_name")

# visualize disruption effects on each gene
ggplot(data = stats)+
  geom_vline(xintercept = 0, linetype = "dashed", col = "darkgray")+
  geom_errorbarh(aes(y = gene_fac, xmin = effect_L, 
                     xmax = effect_H, col = effect_col))+
  geom_point(aes(y = gene_fac, x = effect_mean))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_manual(name = '', values = c("exclude"="red", "include"="black"))+
  xlab(label = "Mean effect")
```



#### Promising results
IgGeneUsage found some promising differences in usage between the two 
conditions. Lets visualize the data in these genes. We can plot the observed 
gene usage (%) and the estimated mean usage with error bars showing 95% HDI of 
mean for each gene and condition. 

```{r, fig.width=8, fig.height=4}
# promising.genes <- c("IGHV1-3", "IGHV3-9", "IGHV4-30-4", "IGHV5-10-1")
promising.genes <- c("IGHV4-30-4", "IGHV3-30-3", "IGHV3-7", "IGHV3-23")

group.ppc <- M$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name %in% promising.genes, ]

point.data <- M$group.ppc$individual.pct.data
point.data <- point.data[point.data$gene_name %in% promising.genes, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, 
                    ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = point.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 1.5, fill = "black",
             position = position_jitterdodge(jitter.width = 0.15, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")
```


#### Promising results (original data)

```{r, fig.width=8, fig.height=4}
# promising.genes <- c("IGHV1-3", "IGHV3-9", "IGHV4-30-4", "IGHV5-10-1")
promising.genes <- c("IGHV4-30-4", "IGHV3-30-3", "IGHV3-7", "IGHV3-23")

ggplot(data = viz[viz$gene_name %in% promising.genes, ])+
  geom_point(aes(x = gene_name, y = gene_usage_count, 
                 fill = condition, size = total/10^3, alpha = 0.5), shape = 21,
             position = position_jitterdodge(dodge.width = 0.5,
                                             jitter.width = 0.15))+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_size_continuous(name = "N (in thousands)", range = c(2, 6))
```





#### Comparison with the t-test
Despite the fact that both assumptions made by the t-test are violated, i.e.
(1) the assumption of normally distributed data and (2) homoscedasticity, the
t-test if often used in the literature for differential gene usage analysis. 
To use the t-test, researchers compute the usage proportions (and not the raw 
counts). With that, they discard data about the sample size. Here, we 
nevertheless compare our results against p-values obtained with a  t-test (with 
assumption of unequal variance). These statistics are automatically estimated by 
IgGeneUsage.

The following figure compares the effect sizes obtained from the Bayesian 
analysis with the p-values obtained from the t-test. Legend:

  * y-axis: FDR-corrected p-value shown on -log10 scale. Dashed lines represent 
  the significance levels of 0.05 and 0.01. 
  * x-axis: probability of differential gene usage
  * color: effect size excludes null. 
  
We can notice a few deviations between the two analyses. Lets inspect the 
corresponding genes more closely.

```{r, fig.width=8, fig.height=5}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), linetype = "dashed")+
  geom_point(aes(x = pmax, y = -log10(t.test.fdr.pvalue), col = effect_col), size = 1.5)+
  geom_text_repel(aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                label = gene_name, col = effect_col), size = 2.5)+
  xlim(0.5, 1)+
  ylab(label = "-log10(p-value) from t-test [FDR corrected]")+
  xlab(label = "pmax")+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```



#### Outliers: IGHV1-58 and IGHV3-72

```{r, fig.width=8, fig.height=4}
promising.genes <- c("IGHV1-58", "IGHV3-72")

group.ppc <- M$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name %in% promising.genes, ]

point.data <- M$group.ppc$individual.pct.data
point.data <- point.data[point.data$gene_name %in% promising.genes, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, 
                    ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = point.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 1.5, fill = "black",
             position = position_jitterdodge(jitter.width = 0.15, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")
```


#### Outliers: IGHV1-58 and IGHV3-72 (original data)

```{r, fig.width=8, fig.height=4}
promising.genes <- c("IGHV1-58", "IGHV3-72")

ggplot(data = viz[viz$gene_name %in% promising.genes, ])+
  geom_point(aes(x = gene_name, y = gene_usage_count, 
                 fill = condition, size = total/10^3, alpha = 0.5), shape = 21,
             position = position_jitterdodge(dodge.width = 0.5,
                                             jitter.width = 0.15))+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_size_continuous(name = "N (in thousands)", range = c(2, 6))
```





#### Comparison with the Wilcoxon rank-sum test (U-test)
Another popular method for differential gene usage analysis is the nonparametric
U-test. Its assumption of expecting equal shape is also not met by our data. 
Here, we nevertheless compare our results against p-values obtained with a the
U-test, which are automatically estimated by IgGeneUsage.

The following figure compares the effect sizes obtained from the Bayesian 
analysis with the p-values obtained from the U-test. Legend:

  * y-axis: FDR-corrected p-value shown on -log10 scale. Dashed lines represent 
  the significance levels of 0.05 and 0.01. 
  * x-axis: probability of differential gene usage
  * color: effect size excludes null. 

We observe similar results as in the case of the t-test. We can see that the 
U-test is under-powered to detect statistically significant differences in gene 
usage. This is both due to the low sample size and also due to the correction
for multiple comparison.

```{r, fig.width=8, fig.height=5}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), linetype = "dashed")+
  geom_point(aes(x = pmax, y = -log10(u.test.fdr.pvalue), col = effect_col), size = 1.5)+
  geom_text_repel(aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                label = gene_name, col = effect_col), size = 2.5)+
  xlim(0.5, 1)+
  ylab(label = "-log10(p-value) from U-test [FDR corrected]")+
  xlab(label = "pmax")+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```




## Case Study II

A small example database subset from study evaluating vaccine-induced changes in
B-cell populations [^3]. The IGHV family usage is reported in four B-cell
populations (samples IgM, IgD, IgG and IgA) across two timepoints (conditions
= -1 hour and +7 days). In this case study we investigate the overal effect of
the vaccine on the IGHV family usage.

[^3]: Laserson U and Vigneault F, et al. High-resolution antibody dynamics of
vaccine-induced immune responses. Proc Natl Acad Sci USA. 2014 111:4928-33.



### Input data

```{r}
data(Ig)
head(Ig)
```


### Data visualization
Lets look at the input data with ggplot2.

```{r, fig.width=7, fig.height=4}
# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition,
                         FUN = sum, data = Ig)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = Ig, y = total.usage,
             by = c("sample_id", "condition"),
             all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100

# visualize
ggplot(data = viz)+
  geom_point(aes(x = gene_name, y = gene_usage_pct, 
                 fill = condition, shape = condition), stroke = 0,
             position = position_jitterdodge(jitter.width = 0.15, 
                                             dodge.width = 0.5))+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```

### Analysis with IgGeneUsage

This is the main method of IgGeneUsage for differential gene usage.

```{r}
# M <- diffUsage(usage.data = Ig,
#                mcmc.warmup = 1000,
#                mcmc.steps = 2500,
#                mcmc.chains = 4,
#                mcmc.cores = 4,
#                hdi.level = 0.95,
#                adapt.delta = 0.95,
#                max.treedepth = 13,
#                dev.model = "src/stan_files/beta_binomial_model.stan")
# save(M, file = "R/dev/saved_temp/M_IG.RData")
M <- get(load(file = "R/dev/alakazam_zibb_model.RData"))
```




### Model checking

#### Checking MCMC sampling

  * divergences, tree-depth, energy

```{r}
rstan::check_hmc_diagnostics(M$glm)
```

  * Rhat and Neff

```{r, fig.width=7, fig.height=3}
grid.arrange(rstan::stan_rhat(object = M$glm),
             rstan::stan_ess(object = M$glm),
             nrow = 1)
```


#### Repertoire-specific PPC

```{r, fig.height=4, fig.width=6}
ggplot(data = M$ppc)+
  facet_wrap(facets = ~sample_id, ncol = 4)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw, y = ppc.raw.mean, ymin = ppc.raw.L, ymax = ppc.raw.H))+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()+
  xlab(label = "Observed usage [counts]")+
  ylab(label = "Predicted usage [counts]")
```




#### Gene-specific PPC

```{r, fig.width=3, fig.height=3}
ggplot(data = M$group.ppc$group.ppc)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
  geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  xlab(label = "Observed usage [%]")+
  ylab(label = "Predicted usage [%]")
```



#### Leave-one-out comparison
  * with R-package loo

```{r}
loo::loo(x = loo::extract_log_lik(stanfit = M$glm))
```


### Results

```{r, fig.height=3, fig.width=5}
# format data
stats <- M$glm.summary
stats$effect_col <- ifelse(test = stats$effect_L <= 0 & stats$effect_H >= 0,
                           yes = "include", no = "exclude")
stats <- stats[order(abs(stats$effect_mean), decreasing = F), ]
stats$gene_fac <- factor(x = stats$gene_name,
                         levels = stats$gene_name)

stats <- merge(x= stats, y = M$test.stats, by = "gene_name")

# visualize disruption effects on each gene
ggplot(data = stats)+
  geom_vline(xintercept = 0, linetype = "dashed", col = "darkgray")+
  geom_errorbarh(aes(y = gene_fac, xmin = effect_L, 
                     xmax = effect_H, col = effect_col))+
  geom_point(aes(y = gene_fac, x = effect_mean))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_manual(name = '', values = c("exclude"="red", "include"="black"))+
  xlab(label = "Mean effect")
```





#### Comparison with the t-test
We again compare the effect sizes obtained from the Bayesian analysis with the 
p-values obtained from the t-test. Legend:

  * y-axis: FDR-corrected p-value shown on -log10 scale. Dashed lines represent 
  the significance levels of 0.05 and 0.01. 
  * x-axis: probability of differential gene usage
  * color: effect size excludes null. 
  
We can notice one deviation between the two tests, namely the gene family IGHV5.
Lets inspect this gene more closely.

```{r, fig.width=8, fig.height=5}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), linetype = "dashed")+
  geom_point(aes(x = pmax, y = -log10(t.test.fdr.pvalue), col = effect_col), 
             size = 1.5)+
  geom_text_repel(aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                label = gene_name, col = effect_col), size = 2.5)+
  xlim(0.5, 1)+
  ylab(label = "-log10(p-value) from t-test [FDR corrected]")+
  xlab(label = "pmax")+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```



#### Outliers: IGHV5

```{r, fig.width=8, fig.height=4}
promising.genes <- "IGHV5"

group.ppc <- M$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name %in% promising.genes, ]

point.data <- M$group.ppc$individual.pct.data
point.data <- point.data[point.data$gene_name %in% promising.genes, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, 
                    ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = point.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 1.5, fill = "black",
             position = position_jitterdodge(jitter.width = 0.15, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")
```


#### Outliers: IGHV5 (original data)

```{r, fig.width=8, fig.height=4}
promising.genes <- "IGHV5"

ggplot(data = viz[viz$gene_name %in% promising.genes, ])+
  geom_point(aes(x = gene_name, y = gene_usage_count, 
                 fill = condition, size = total/10^2, alpha = 0.5), shape = 21,
             position = position_jitterdodge(dodge.width = 0.5,
                                             jitter.width = 0.15))+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_size_continuous(name = "N (in hundreds)", range = c(2, 6))
```





#### Comparison with the Wilcoxon rank-sum test (U-test)
We again compare the effect sizes obtained from the Bayesian analysis with the 
p-values obtained from the U-test. Legend:

  * y-axis: FDR-corrected p-value shown on -log10 scale. Dashed lines represent 
  the significance levels of 0.05 and 0.01. 
  * x-axis: probability of differential gene usage
  * color: effect size excludes null. 

Both methods report no significant differential gene usages.

```{r, fig.width=8, fig.height=5}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), linetype = "dashed")+
  geom_point(aes(x = pmax, y = -log10(u.test.fdr.pvalue), col = effect_col), 
             size = 1.5)+
  geom_text_repel(aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                label = gene_name, col = effect_col), size = 2.5)+
  xlim(0.5, 1)+
  ylab(label = "-log10(p-value) from U-test [FDR corrected]")+
  xlab(label = "pmax")+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```







## Case Study III

The main purpose of using IgGeneUsage is to evaluate differential gene usage. 
However, the tool can be used to analyze different repertoire properties such 
as differential CDR3-sequence charge and length usage. In principle, all tasks 
that fall under the scope of binomial regression can be tackled by IgGeneUsage.

In the third case study we explain how to perform differential CDR3-sequence
charge usage between two biological conditions (InfluenzaA and CSM infection), 
using Human CDR3 sequence data downloaded from VDJdb [^4].

We consider the amino acids K, R and H as +1 charged, while D and E as -1 
charged. We computed the net charge of a CDR3 sequence by adding up the 
individual charges. We consider the different sources (publications) as 
different subjects (repertoires).

[^4]: https://vdjdb.cdr3.net/


### Input data

```{r}
data(CDR3_Epitopes)
head(CDR3_Epitopes)
```


### Data visualization

Lets look at the input data with ggplot2.

```{r, fig.width=7, fig.height=4}
# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition,
                         FUN = sum, data = CDR3_Epitopes)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = CDR3_Epitopes, y = total.usage,
             by = c("sample_id", "condition"),
             all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100

# visualize
ggplot(data = viz)+
  geom_point(aes(x = as.numeric(gene_name), y = gene_usage_pct, fill = condition, 
                 shape = condition), stroke = 0, size = 2, alpha = 0.5,
             position = position_jitterdodge(jitter.width = 0.15, 
                                             dodge.width = 0.5))+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))+
  scale_x_continuous(breaks = -7:7, labels = -7:7)
```



### Analysis with IgGeneUsage

This is the main method of IgGeneUsage for differential gene usage.

```{r}
# M <- diffUsage(usage.data = CDR3_Epitopes,
#                mcmc.warmup = 1000,
#                mcmc.steps = 2500,
#                mcmc.chains = 4,
#                mcmc.cores = 4,
#                hdi.level = 0.95,
#                adapt.delta = 0.95,
#                max.treedepth = 13,
#                dev.model = "src/stan_files/zibb_model.stan")

# save(M, file = "R/dev/epitopes_zibb_model.RData")
M <- get(load(file = "R/dev/epitopes_zibb_model.RData"))
```




### Model checking

#### Checking MCMC sampling

  * divergences, tree-depth, energy

```{r}
rstan::check_hmc_diagnostics(M$glm)
```

  * Rhat and Neff

```{r, fig.width=7, fig.height=3}
grid.arrange(rstan::stan_rhat(object = M$glm),
             rstan::stan_ess(object = M$glm),
             nrow = 1)
```


#### Repertoire-specific PPC

```{r, fig.height=6, fig.width=6}
ggplot(data = M$ppc)+
  facet_wrap(facets = ~sample_id, ncol = 4)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw, y = ppc.raw.mean, ymin = ppc.raw.L, ymax = ppc.raw.H))+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()+
  xlab(label = "Observed usage [counts]")+
  ylab(label = "Predicted usage [counts]")
```




#### Gene-specific PPC

```{r, fig.width=3, fig.height=3}
ggplot(data = M$group.ppc$group.ppc)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
  geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  xlab(label = "Observed usage [%]")+
  ylab(label = "Predicted usage [%]")
```



#### Leave-one-out comparison
  * with R-package loo

```{r}
loo::loo(x = loo::extract_log_lik(stanfit = M$glm))
```


### Results

```{r, fig.height=3, fig.width=5}
# format data
stats <- M$glm.summary
stats$effect_col <- ifelse(test = stats$effect_L <= 0 & stats$effect_H >= 0,
                           yes = "include", no = "exclude")
stats <- stats[order(abs(stats$effect_mean), decreasing = F), ]
stats$gene_fac <- factor(x = stats$gene_name,
                         levels = stats$gene_name)

stats <- merge(x= stats, y = M$test.stats, by = "gene_name")

# visualize disruption effects on each gene
ggplot(data = stats)+
  geom_vline(xintercept = 0, linetype = "dashed", col = "darkgray")+
  geom_errorbarh(aes(y = as.numeric(as.character(gene_fac)), xmin = effect_L, 
                     xmax = effect_H, col = effect_col))+
  geom_point(aes(y = as.numeric(as.character(gene_fac)), x = effect_mean))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_manual(name = '', values = c("exclude"="red", "include"="black"))+
  xlab(label = "Mean effect")+
  ylab(label = "Net Charge")
```





#### Comparison with the t-test
We again compare the effect sizes obtained from the Bayesian analysis with the 
p-values obtained from the t-test. Legend:

  * y-axis: FDR-corrected p-value shown on -log10 scale. Dashed lines represent 
  the significance levels of 0.05 and 0.01. 
  * x-axis: probability of differential gene usage
  * color: effect size excludes null. 
  
We can notice one deviation between the two tests, namely the gene family IGHV5.
Lets inspect this gene more closely.

```{r, fig.width=8, fig.height=5}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), linetype = "dashed")+
  geom_point(aes(x = pmax, y = -log10(t.test.fdr.pvalue), col = effect_col), 
             size = 1.5)+
  geom_text_repel(aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                label = gene_name, col = effect_col), size = 2.5)+
  xlim(0.5, 1)+
  ylab(label = "-log10(p-value) from t-test [FDR corrected]")+
  xlab(label = "pmax")+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```








#### Comparison with the Wilcoxon rank-sum test (U-test)
We again compare the effect sizes obtained from the Bayesian analysis with the 
p-values obtained from the U-test. Legend:

  * y-axis: FDR-corrected p-value shown on -log10 scale. Dashed lines represent 
  the significance levels of 0.05 and 0.01. 
  * x-axis: probability of differential gene usage
  * color: effect size excludes null. 

Both methods report no significant differential gene usages.

```{r, fig.width=8, fig.height=5}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), linetype = "dashed")+
  geom_point(aes(x = pmax, y = -log10(u.test.fdr.pvalue), col = effect_col), 
             size = 1.5)+
  geom_text_repel(aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                label = gene_name, col = effect_col), size = 2.5)+
  xlim(0.5, 1)+
  ylab(label = "-log10(p-value) from U-test [FDR corrected]")+
  xlab(label = "pmax")+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```





