---
title: "IgGeneUsage"
author: "SK"
date: "June 25, 2019"
output: 
  html_document: 
    highlight: tango
    theme: journal
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
require(ggplot2)
require(gridExtra)
require(rstan)
require(ggrepel)


rstan_options(auto_write = TRUE)

source(file = "R/Util.R")
source(file = "R/Usage.R")
```





## Introduction

The IgGeneUsage package comes with a few gene usage datasets taken from the 
following publications:
  * D1: XXX
  * D2: XXX
In this tutorial we explore the different functionalities of the R package using
these datasets.



## Case Study
### D1: XXX

```{r}
# data(IGHV_HCV_CSM)
IGHV_HCV_CSM <- get(load(file = "inst/IGHV_HCV_CSM.RData"))
IGHV_HCV_CSM <- IGHV_HCV_CSM[, c("sample_id", "condition", 
                                 "gene_name", "gene_usage_count")]

# estimate total usage per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition, 
                         FUN = sum, data = IGHV_HCV_CSM)
total.usage$total_usage_count <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

IGHV_HCV_CSM <- merge(x = IGHV_HCV_CSM, y = total.usage, by = c("sample_id", "condition"), all.x = T)
IGHV_HCV_CSM$gene_usage_pct <- IGHV_HCV_CSM$gene_usage_count/IGHV_HCV_CSM$total_usage_count*100
```


```{r, fig.width=7, fig.height=4}
IGHV_HCV_CSM$bit <- IGHV_HCV_CSM$gene_usage_pct < 1
bit.m <- table(IGHV_HCV_CSM$gene_name, IGHV_HCV_CSM$bit)

ggplot(data = IGHV_HCV_CSM[!IGHV_HCV_CSM$gene_name %in% names(which(bit.m[, "TRUE"] == 29)), ])+
  geom_point(aes(x = gene_name, y = gene_usage_pct, 
                 fill = condition, shape = condition),
             position = position_dodge(width = 1), stroke = 0)+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```


```{r}
IGHV_HCV_CSM <- IGHV_HCV_CSM[, c("sample_id", "condition", 
                                 "gene_name", "gene_usage_count")]

usage.hcv.csm <- diffUsage(usage.data = IGHV_HCV_CSM,
                           mcmc.warmup = 500,
                           mcmc.steps = 1500,
                           mcmc.chains = 4,
                           mcmc.cores = 4,
                           hdi.level = 0.95,
                           adapt.delta = 0.95,
                           max.treedepth = 13,
                           dev.model = "src/stan_files/beta_binomial_model.stan")
# save(usage.hcv.csm, file = "R/dev/beta_binomial.RData")
```




### Repertoire-specific PPC

```{r, fig.height=8, fig.width=6}
ppc <- usage.hcv.csm$ppc
ggplot(data = ppc)+
  facet_wrap(facets = ~sample_id, ncol = 5)+
  geom_abline(intercept = 0, slope = 1)+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")
```




### Gene x Condition -specific PPC

```{r, fig.width=10, fig.height=5}
# usage.hcv.csm <- get(load(file = "R/dev/b.RData"))
# usage.hcv.csm <- get(load(file = "R/dev/zib_multiz.RData"))

ggplot()+
  geom_errorbar(data = usage.hcv.csm$group.ppc$group.ppc,
                aes(x = gene_name, ymin = ppc.L,
                    ymax = ppc.H, col = condition),
                position = position_dodge(width = .8),
                width = 1, size = 1)+
  geom_point(data = usage.hcv.csm$group.ppc$individual.pct.data,
             aes(x = gene_name, y = gene_usage_pct,
                 col = condition), shape = 21, size = 0.75,
             position = position_dodge(width = .8), fill = "black")+
  theme_bw(base_size = 9)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4),
        legend.position = "top")
```




```{r, fig.height=8, fig.width=5}
getMinEffect <- function(x) {
  if(x[1] <= 0 & x[2] >= 0) {
    return (0)
  }
  return(min(abs(c(x[1], x[2]))))
}

stats <- usage.hcv.csm$glm.summary
stats$effect_min <- apply(X = stats[, c("effect_L", "effect_H")], MARGIN = 1, FUN = getMinEffect)
stats$effect_col <- ifelse(test = stats$effect_min == 0, yes = "black", no = "red")
stats <- stats[order(abs(stats$effect_mean), decreasing = F), ]
stats$gene_fac <- factor(x = stats$gene_name, levels = stats$gene_name)

ggplot(data = stats)+
  geom_vline(xintercept = 0, linetype = "dashed", col = "darkgray")+
  geom_errorbarh(aes(y = gene_fac, xmin = effect_L, 
                     xmax = effect_H, col = effect_col))+
  geom_point(aes(y = gene_fac, x = effect_mean))+
  theme_bw(base_size = 9)
```






### Comparison of results

```{r, fig.width=6, fig.height=6}
stats <- merge(x= usage.hcv.csm$glm.summary,
               y = usage.hcv.csm$test.stats, 
               by = "gene_name")

stats <- stats[order(-log10(stats$t.test.pvalue), decreasing = T), ]
stats$rank.t <- 1:nrow(stats)
stats <- stats[order(-log10(stats$u.test.pvalue), decreasing = T), ]
stats$rank.u <- 1:nrow(stats)
stats <- stats[order(stats$pmax, decreasing = T), ]
stats$rank.pmax <- 1:nrow(stats)
```




```{r}
ggplot(data = stats)+
  geom_text_repel(aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                label = gene_name), size = 2.5)+
  xlim(0.5, 1)
```




```{r}
ggplot(data = stats)+
  geom_text_repel(aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                label = gene_name), size = 2.5)+
  xlim(0.5, 1)
```



```{r, fig.width=5, fig.height=4}
gene_name <- "IGHV5-10-1"
group.ppc <- usage.hcv.csm$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name == gene_name, ]

individual.data <- usage.hcv.csm$group.ppc$individual.pct.data
individual.data <- individual.data[individual.data$gene_name == gene_name, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = individual.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 2, fill = "black",
             position = position_jitterdodge(jitter.width = 0.25, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")

# usage.hcv.csm$usage.data$Y[gene_name, ]
# paste(usage.hcv.csm$usage.data$Y[gene_name, ], collapse = ', ')
# paste(usage.hcv.csm$usage.data$X, collapse = ', ')
```

```{r}
# e <- rstan::extract(object = usage.hcv.csm$glm, pars = c("alpha_gene", "beta_gene", "z"))
# e.i <- which(usage.hcv.csm$usage.data$gene_names == gene_name)
# 
# 
# par(mfrow = c(2, 2))
# hist(e$alpha_gene[, e.i])
# hist(e$beta_gene[, e.i])
# hist((1-e$z[, e.i]) * 1/(1 + exp(-(e$alpha_gene[, e.i] + e$beta_gene[, e.i]))) *100)
# hist((1-e$z[, e.i]) * 1/(1 + exp(-(e$alpha_gene[, e.i] + (-1) * e$beta_gene[, e.i]))) *100)
```



```{r, fig.width=5, fig.height=4}
gene_name <- "IGHV3-23"
group.ppc <- usage.hcv.csm$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name == gene_name, ]

individual.data <- usage.hcv.csm$group.ppc$individual.pct.data
individual.data <- individual.data[individual.data$gene_name == gene_name, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = individual.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 2, fill = "black",
             position = position_jitterdodge(jitter.width = 0.25, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")

usage.hcv.csm$usage.data$Y[gene_name, ]
```




```{r, fig.width=5, fig.height=4}
gene_name <- "IGHV3-72"
group.ppc <- usage.hcv.csm$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name == gene_name, ]

individual.data <- usage.hcv.csm$group.ppc$individual.pct.data
individual.data <- individual.data[individual.data$gene_name == gene_name, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = individual.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 2, fill = "black",
             position = position_jitterdodge(jitter.width = 0.25, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")

usage.hcv.csm$usage.data$Y[gene_name, ]
```


```{r}
e <- rstan::extract(object = usage.hcv.csm$glm, pars = c("alpha_gene", "beta_gene"))
e.i <- which(usage.hcv.csm$usage.data$gene_names == "IGHV1-3")
hist(1/(1+exp(-e$alpha_gene[, e.i]))*100)
```

```{r}
hist(e$beta_gene[, e.i])
hist(1/(1+exp(-(e$alpha_gene[, e.i] + e$beta_gene[, e.i])))*100)
```


### D2: XXX

```{r}
# data(IGHV_HCV_CSM)
test <- get(load(file = "inst/input.RData"))
rm(usage)

# estimate total usage per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition, 
                         FUN = sum, data = test)
total.usage$total_usage_count <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

test <- merge(x = test, y = total.usage, by = c("sample_id", "condition"), all.x = T)
test$gene_usage_pct <- test$gene_usage_count/test$total_usage_count*100
```


```{r, fig.width=7, fig.height=4}
test$bit <- test$gene_usage_pct < 1
bit.m <- table(test$gene_name, test$bit)

ggplot(data = test[!test$gene_name %in% names(which(bit.m[, "TRUE"] == 29)), ])+
  geom_point(aes(x = gene_name, y = gene_usage_pct, 
                 fill = condition, shape = condition),
             position = position_dodge(width = 1), stroke = 0)+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```


```{r}
test <- test[, c("sample_id", "condition", 
                 "gene_name", "gene_usage_count")]

usage.hcv.csm <- diffUsage(usage.data = test,
                           mcmc.warmup = 500,
                           mcmc.steps = 1500,
                           mcmc.chains = 4,
                           mcmc.cores = 4,
                           hdi.level = 0.95,
                           adapt.delta = 0.95,
                           max.treedepth = 13)
```




### Repertoire-specific PPC

```{r, fig.height=6, fig.width=8}
ppc <- usage.hcv.csm$ppc
ggplot(data = ppc)+
  facet_wrap(facets = ~sample_id, ncol = 5)+
  geom_abline(intercept = 0, slope = 1)+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")
```




### Gene x Condition -specific PPC

```{r}
ggplot()+
  geom_errorbar(data = usage.hcv.csm$group.ppc$group.ppc,
                aes(x = gene_name, ymin = ppc.L,
                    ymax = ppc.H, col = condition),
                position = position_dodge(width = .8),
                width = 0.75)+
  geom_point(data = usage.hcv.csm$group.ppc$individual.pct.data,
             aes(x = gene_name, y = gene_usage_pct,
                 col = condition), shape = 21, size = 0.5,
             position = position_dodge(width = .8), fill = "black")+
  theme_bw(base_size = 9)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4),
        legend.position = "top")
```




### Comparison of results

```{r, fig.width=6, fig.height=6}
stats <- merge(x= usage.hcv.csm$glm.summary,
               y = usage.hcv.csm$test.stats, 
               by = "gene_name")

stats <- stats[order(-log10(stats$t.test.pvalue), decreasing = T), ]
stats$rank.t <- 1:nrow(stats)
stats <- stats[order(-log10(stats$u.test.pvalue), decreasing = T), ]
stats$rank.u <- 1:nrow(stats)
stats <- stats[order(stats$pmax, decreasing = T), ]
stats$rank.pmax <- 1:nrow(stats)
```



```{r}
ggplot(data = stats)+
  geom_text_repel(aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                label = gene_name), size = 2.5)
```



```{r}
ggplot(data = stats)+
  geom_text_repel(aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                label = gene_name), size = 2.5)+
  xlim(c(0.5, 1))
```



```{r, fig.width=5, fig.height=4}
gene_name <- "IGHV4-4"
group.ppc <- usage.hcv.csm$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name == gene_name, ]

individual.data <- usage.hcv.csm$group.ppc$individual.pct.data
individual.data <- individual.data[individual.data$gene_name == gene_name, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = individual.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 2, fill = "black",
             position = position_jitterdodge(jitter.width = 0.15, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")

usage.hcv.csm$usage.data$Y[gene_name, ]
paste(usage.hcv.csm$usage.data$Y[gene_name, ], collapse = ', ')
paste(usage.hcv.csm$usage.data$X, collapse = ', ')
```

```{r}
e <- rstan::extract(object = usage.hcv.csm$glm, pars = c("alpha_gene", "beta_gene"))
e.i <- which(usage.hcv.csm$usage.data$gene_names == gene_name)
par(mfrow = c(2, 2))
hist(e$alpha_gene[, e.i])
hist(e$beta_gene[, e.i])
hist(1/(1 + exp(-(e$alpha_gene[, e.i] + e$beta_gene[, e.i])))*100)
hist(1/(1 + exp(-(e$alpha_gene[, e.i] + e$beta_gene[, e.i]*(-1))))*100)
```


```{r, fig.width=5, fig.height=4}
gene_name <- "IGHV1-58"
group.ppc <- usage.hcv.csm$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name == gene_name, ]

individual.data <- usage.hcv.csm$group.ppc$individual.pct.data
individual.data <- individual.data[individual.data$gene_name == gene_name, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = individual.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 2, fill = "black",
             position = position_jitterdodge(jitter.width = 0.25, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")

usage.hcv.csm$usage.data$Y[gene_name, ]
```




```{r, fig.width=5, fig.height=4}
gene_name <- "IGHV3-72"
group.ppc <- usage.hcv.csm$group.ppc$group.ppc
group.ppc <- group.ppc[group.ppc$gene_name == gene_name, ]

individual.data <- usage.hcv.csm$group.ppc$individual.pct.data
individual.data <- individual.data[individual.data$gene_name == gene_name, ]

ggplot()+
  geom_errorbar(data = group.ppc,
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = individual.data,
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 2, fill = "black",
             position = position_jitterdodge(jitter.width = 0.25, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")

usage.hcv.csm$usage.data$Y[gene_name, ]
```


```{r}
e <- rstan::extract(object = usage.hcv.csm$glm, pars = c("alpha_gene", "beta_gene"))
e.i <- which(usage.hcv.csm$usage.data$gene_names == "IGHV1-3")
hist(1/(1+exp(-e$alpha_gene[, e.i]))*100)
```

```{r}
hist(e$beta_gene[, e.i])
hist(1/(1+exp(-(e$alpha_gene[, e.i] + e$beta_gene[, e.i])))*100)
```
