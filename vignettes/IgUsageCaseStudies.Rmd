---
title: "User Manual: IgGeneUsage"
author: "SK"
date: "June 25, 2019"
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{User Manual: IgGeneUsage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(comment = FALSE, warning = FALSE, message = FALSE)
```



```{r}
require(IgGeneUsage)
require(knitr)
require(ggplot2)
require(ggforce)
require(gridExtra)
require(ggrepel)
require(rstan)
require(reshape2)
rstan_options(auto_write = TRUE)
```





# Introduction
Decoding the properties of immune repertoires is key in understanding the 
response of adaptive immunity to challenges such as viral infection. One 
important property is biases in Ig gene usage between biological conditions 
(e.g. healthy vs turmor). Yet, most analyses for differential gene usage are
performed qualitatively, or with inadequate statistical methods. Here we 
introduce IgGeneUsage, a computational tool for the analysis of differential 
gene usage.


# Input
The input to IgGeneUsage is a data.frame object with usage frequencies for each 
gene of a repertoire that belongs to a particular biological condition. The
usage data.frame has the following 4 columns:

  1. sample_id: character identifier of the repertoire (e.g. Patient-1)
  2. condition: character identifier of the condition to which each repertoire 
  belongs (e.g. healthy or tumor)
  3. gene_name: specific gene name (e.g. IGHV1-10 or family TRVB1)
  4. gene_usage_count: numeric (count) of usage related to columns 1-3

The sum of all gene usage counts (column 4) in a given repertoire is equal to 
the total gene usage in that repertoire. 



# Case Study I
IgGeneUsage has built-in datasets from studies that evaluate biases in gene 
usage. The dataset IGHV_HCV, used in this case study, contains publicly 
available data of human immunoglobulin heavy chain VDJ rearrangements from a 
study that evaluates the effect of HCV infection on the human BCR repertoire 
[^1]. The dataset consists of a population of class-switched memory (CSM) B 
cells of 22 HCV-infected patients (HCV+) and 7 healthy donors (HD). Gene usage 
data is available for 69 IGHV gene segments.

[^1]: Tucci, Felicia A., et al. "Biased IGH VDJ gene repertoire and clonal 
expansions in B cells of chronically hepatitis C virusâ€“infected individuals." 
Blood 131.5 (2018): 546-557.]


## Input data

```{r}
data("IGHV_HCV", package = "IgGeneUsage")
```


```{r}
kable(x = head(IGHV_HCV), 
      row.names = FALSE)
```



## Data visualization

Lets look at the gene usage data with ggplot2.

```{r, fig.height = 6, fig.width = 10}
# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition, 
                         FUN = sum, data = IGHV_HCV)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = IGHV_HCV, y = total.usage, 
             by = c("sample_id", "condition"), 
             all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100

# for this example lets only consider the top 50 genes
top <- aggregate(gene_usage_pct~gene_name, data = viz, FUN = mean)
top <- top[order(top$gene_usage_pct, decreasing = TRUE), ]
IGHV_HCV <- IGHV_HCV[IGHV_HCV$gene_name %in% top$gene_name[1:50], ]
viz <- viz[viz$gene_name %in% top$gene_name[1:50], ]

# visualize
ggplot(data = viz)+
  geom_point(aes(x = gene_name, y = gene_usage_pct, 
                 fill = condition, shape = condition),
             position = position_dodge(width = .7), stroke = 0)+
  theme_bw(base_size = 12)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```



## Analysis of differential gene usage with IgGeneUsage

This is the main method of IgGeneUsage.

```{r}
# Differential gene usage (DGU)
M <- DGU(usage.data = IGHV_HCV,
         mcmc.warmup = 250,
         mcmc.steps = 750,
         mcmc.chains = 2,
         mcmc.cores = 2,
         hdi.level = 0.95,
         adapt.delta = 0.95,
         max.treedepth = 10)
```




## Model checking

Do not blindly trust the model $\rightarrow$ check it extensively. 

  * Checklist of successful MCMC sampling[^2]:
      * no divergences, no excessive warnings from rstan, Rhat < 1.05, 
      high Neff (see object glm.stats, glm and Stan documentation)
  * Checklist for valid model:
      * observed data can be replicated with the fitted model $\rightarrow$ 
      posterior predictive checks
      * leave-one-out analysis

[^2]: https://mc-stan.org/misc/warnings.html

### MCMC sampling

  * divergences, tree-depth, energy
  
```{r}
rstan::check_hmc_diagnostics(M$glm)
```

  * Rhat and Neff

```{r, fig.height = 3, fig.width = 8}
grid.arrange(rstan::stan_rhat(object = M$glm),
             rstan::stan_ess(object = M$glm),
             nrow = 1)
```


### Posterior predictive checks: repertoire-specific

IgGeneUsage has built-in checks for repertoire-specific posterior 
prediction of gene usage. We show the predictions (y-axis) of the model,
and compare them against the observed data (x-axis). If the points are near 
the diagnoal $\rightarrow$ accurate prediction. Errors show 95% HDI of mean
posterior prediction (shown in counts).

```{r, fig.height = 10, fig.width = 10}
ggplot(data = M$ppc.data$ppc.repertoire)+
  facet_wrap(facets = ~sample_id, ncol = 6)+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", col = "darkgray")+
  geom_errorbar(aes(x = observed.count, y = ppc.count.mean, 
                    ymin = ppc.count.L, ymax = ppc.count.H), 
                col = "darkgray")+
  geom_point(aes(x = observed.count, y = ppc.count.mean, 
                 fill = condition), shape = 21, size = 2)+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()+
  xlab(label = "Observed usage [counts]")+
  ylab(label = "Predicted usage [counts]")
```




### Posterior predictive checks: overall

IgGeneUsage has built-in checks for gene-specific posterior prediction 
of gene usage within biological conditions. We show the predictions (y-axis) 
of the model, and compare them against the observed mean usage (x-axis). If 
the points are near the diagnoal $\rightarrow$ accurate prediction. Errors
show 95% HDI of mean posterior prediction.

```{r, fig.height=5, fig.width = 6}
ggplot(data = M$ppc.data$ppc.gene)+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", col = "darkgray")+
  geom_errorbar(aes(x = observed.mean, ymin = ppc.L, ymax = ppc.H), 
                col = "darkgray")+
  geom_point(aes(x = observed.mean, y = ppc.mean, fill = condition), 
             shape = 21, size = 2)+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  xlab(label = "Observed usage [%]")+
  ylab(label = "Predicted usage [%]")
```



### Leave-one-out
  
```{r}
rstan::loo(x = M$glm)
```


## Results

Next we show results of IgGeneUsage $\rightarrow$ probability of differential
gene usage ($\pi$) shown on the y-axis for different genes (shown as points). 
Names of genes with $\pi > 0.95$ are shown.

```{r, fig.height=4, fig.width = 5}
# format data
stats <- M$glm.summary
stats <- stats[order(abs(stats$effect_mean), decreasing = FALSE), ]
stats$gene_fac <- factor(x = stats$gene_name, levels = stats$gene_name)

stats <- merge(x= stats, y = M$test.stats, by = "gene_name")

ggplot()+
  geom_point(data = stats[stats$pmax < 0.95, ], aes(y = pmax, x = ''),
             position = position_jitter(width = 0.25, height = 0))+
  geom_text(data = stats[stats$pmax >= 0.95, ], size = 4, 
                  aes(y = pmax, x = '', label = gene_name), 
                  position = position_jitter(width = 0.5, height = 0))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  xlab(label = "")+
  ylab(label = expression(pi))+
  ylim(c(0.5, 1))
```



### Promising hits

Lets visualize the observed data of the genes with high probability of 
differential gene usage ($\pi > 0.95$). Here we show the gene usage in %.

```{r, fig.height = 5, fig.width = 8}
promising.genes <- stats$gene_name[stats$pmax >= 0.95]

ppc.gene <- M$ppc.data$ppc.gene
ppc.gene <- ppc.gene[ppc.gene$gene_name %in% promising.genes, ]

ggplot()+
  geom_errorbar(data = ppc.gene, aes(x = gene_name, ymin = ppc.L, 
                                     ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = viz[viz$gene_name %in% promising.genes, ],
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 1.5, fill = "black",
             position = position_jitterdodge(jitter.width = 0.15, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  ylab(label = "Usage [%]")+
  xlab(label = '')
```


### Promising hits [count]

Lets also visualize the gene usage frequencies. Point size represents 
total usage in repertoire.

```{r, fig.height = 8, fig.width = 7}
promising.genes <- stats$gene_name[stats$pmax >= 0.95]

ggplot(data = viz[viz$gene_name %in% promising.genes, ])+
  facet_wrap(facets = ~gene_name, ncol = 1, scales = "free_y")+
  geom_point(aes(x = sample_id, y = gene_usage_count, fill = condition, 
                 size = total/10^3), shape = 21)+
  theme_bw(base_size = 12)+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  theme(legend.position = "top")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_size_continuous(name = "N (10^3)", range = c(2, 6))+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  scale_y_log10()+
  annotation_logticks(base = 10, sides = "l")
```





## Comparison with the Welch's t-test (T-test)

Despite the fact that the data is not normaly distributed, we performed the
analysis of differential gene usage with the T-test. Prior to using the T-test, 
we must convert the usage frequencies into proportions. This is automatically
done by IgGeneUsage.

Next, we compare the probabilities of differential gene usage ($\pi$) with the 
FDR corrected P-values (-log10 scale) from the T-test. Dashed lines show 
significancelevels of 0.05 and 0.01. We observe few disagreements between the 
two tests. Lets inspect them in more detail.

```{r, fig.height=6, fig.width = 10}
ggplot()+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), 
             linetype = "dashed", col = "darkgray")+
  geom_point(data = stats, col = "red", size = 2,
             aes(x = pmax, y = -log10(t.test.fdr.pvalue)))+
  geom_text_repel(data = stats[stats$pmax >= 0.7, ], 
                  aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                      label = gene_name), size = 4, 
                  min.segment.length = 0.1)+
  xlim(0.5, 1)+
  ylab(label = "-log10 (P-value) from t-test [FDR corrected]")+
  xlab(label = expression(pi))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```



### Outliers: IGHV1-58 and IGHV3-72

The two genes IGHV1-58 and IGHV3-72 are prioritized by the T-test. Their $\pi$ 
estimates are however far from 1. Violation of T-test's assumptions is the most
probable cause for the disagreement. Discarding information about the sample 
size, and thus about uncertainty could be an alternative explanation. Lets
visualize the data for IGHV1-58 and IGHV3-72.

```{r, fig.height = 4, fig.width = 6}
promising.genes <- c("IGHV1-58", "IGHV3-72")

ppc.gene <- M$ppc.data$ppc.gene
ppc.gene <- ppc.gene[ppc.gene$gene_name %in% promising.genes, ]

ggplot()+
  geom_errorbar(data = ppc.gene, aes(x = gene_name, ymin = ppc.L, 
                                     ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = viz[viz$gene_name %in% promising.genes, ],
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 1.5, fill = "black",
             position = position_jitterdodge(jitter.width = 0.15, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  ylab(label = "Gene usage [%]")+
  xlab(label = '')
```


### Outliers: IGHV1-58 and IGHV3-72 [counts]

```{r, fig.height = 5, fig.width = 6}
promising.genes <- c("IGHV1-58", "IGHV3-72")

ggplot(data = viz[viz$gene_name %in% promising.genes, ])+
  facet_wrap(facets = ~gene_name, ncol = 1, scales = "free_y")+
  geom_point(aes(x = sample_id, y = gene_usage_count, fill = condition, 
                 size = total/10^3), shape = 21)+
  theme_bw(base_size = 12)+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  theme(legend.position = "top")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_size_continuous(name = "N (10^3)", range = c(2, 6))+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  scale_y_log10()+
  annotation_logticks(base = 10, sides = "l")
```




## Comparison with the Wilcoxon signed-rank test (U-test)

The nonparametric U-test can also be used for the analysis of differential gene
usage. It assumes data with equal shape in both groups (also not met by our 
data). Prior to using the U-test, we must again convert the usage frequencies
into proportions. This is automatically done by IgGeneUsage.

Lets also compare $\pi$ with the FDR corrected P-values (-log10 scale) from 
the U-test. Dashed lines show significancelevels of 0.05 and 0.01. The U-test 
finds no evidence of differential gene usage.

```{r, fig.height=6, fig.width = 10}
ggplot()+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), 
             linetype = "dashed", col = "darkgray")+
  geom_point(data = stats, col = "red", size = 2,
             aes(x = pmax, y = -log10(u.test.fdr.pvalue)))+
  geom_text_repel(data = stats[stats$pmax >= 0.8, ], 
                  aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                      label = gene_name), size = 4, 
                  min.segment.length = 0.1)+
  xlim(0.5, 1)+
  ylab(label = "-log10 (P-value) from U-test [FDR corrected]")+
  xlab(label = expression(pi))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```




# Case Study II

For our second case study we use a dataset from a study evaluating 
vaccine-induced changes in B-cell populations [^3]. The data is publicly 
provided via the R-package alakazam (version 0.2.11). The IGHV family usage is
reported in four B-cell populations (repertoires IgM, IgD, IgG and IgA) across 
two timepoints (conditions = -1 hour vs. +7 days). In this case study we 
investigate the overal effect of the vaccine on the IGHV family usage.

[^3]: Laserson U and Vigneault F, et al. High-resolution antibody dynamics of
vaccine-induced immune responses. Proc Natl Acad Sci USA. 2014 111:4928-33.

## Input data

```{r}
data(Ig, package = "IgGeneUsage")
```


```{r}
kable(x = head(Ig), 
      row.names = FALSE)
```



## Data visualization

Lets look at the gene usage data with ggplot2.

```{r, fig.height = 4, fig.width = 6}
# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition,
                         FUN = sum, data = Ig)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = Ig, y = total.usage,
             by = c("sample_id", "condition"),
             all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100

# visualize
ggplot(data = viz)+
  geom_point(aes(x = gene_name, y = gene_usage_pct, fill = condition, 
                 shape = condition), stroke = 0, size = 3,
             position = position_jitterdodge(jitter.width = 0.25, 
                                             dodge.width = 0.75))+
  theme_bw(base_size = 12)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top")+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```


## Analysis with IgGeneUsage

```{r}
M <- DGU(usage.data = Ig,
         mcmc.warmup = 500,
         mcmc.steps = 1500,
         mcmc.chains = 2,
         mcmc.cores = 2,
         hdi.level = 0.95,
         adapt.delta = 0.95,
         max.treedepth = 13)
```




## Model checking

### Checking MCMC sampling

  * divergences, tree-depth, energy

```{r}
rstan::check_hmc_diagnostics(M$glm)
```

  * Rhat and Neff

```{r, fig.height = 3, fig.width = 8}
grid.arrange(rstan::stan_rhat(object = M$glm),
             rstan::stan_ess(object = M$glm),
             nrow = 1)
```


### Posterior predictive checks: repertoire-specific

```{r, fig.height = 5, fig.width = 8}
ggplot(data = M$ppc$ppc.repertoire)+
  facet_wrap(facets = ~sample_id, ncol = 4)+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", col = "darkgray")+
  geom_errorbar(aes(x = observed.count, y = ppc.count.mean, 
                    ymin = ppc.count.L, ymax = ppc.count.H), 
                col = "darkgray")+
  geom_point(aes(x = observed.count, y = ppc.count.mean, 
                 fill = condition), shape = 21, size = 2)+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()+
  xlab(label = "Observed usage [counts]")+
  ylab(label = "Predicted usage [counts]")
```




### Posterior predictive checks: overall

```{r, fig.height = 4, fig.width = 6}
ggplot(data = M$ppc.data$ppc.gene)+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", col = "darkgray")+
  geom_errorbar(aes(x = observed.mean, ymin = ppc.L, ymax = ppc.H), 
                col = "darkgray")+
  geom_point(aes(x = observed.mean, y = ppc.mean, fill = condition), 
             shape = 21, size = 2)+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  xlab(label = "Observed usage [%]")+
  ylab(label = "Predicted usage [%]")
```



### Leave-one-out

```{r}
rstan::loo(x = M$glm)
```


## Results

Lets visualize the probability of differential gene usage ($\pi$) for different
genes (shown as points). There are no witn $\pi > 0.95$.

```{r, fig.height = 4, fig.width = 5}
# format data
stats <- M$glm.summary
stats <- stats[order(abs(stats$effect_mean), decreasing = FALSE), ]
stats$gene_fac <- factor(x = stats$gene_name, levels = stats$gene_name)

stats <- merge(x= stats, y = M$test.stats, by = "gene_name")

ggplot()+
  geom_point(data = stats[stats$pmax < 0.95, ], aes(y = pmax, x = ''),
             position = position_jitter(width = 0.25, height = 0))+
  # geom_text(data = stats[stats$pmax >= 0.95, ], size = 4, 
  #                 aes(y = pmax, x = '', label = gene_name), 
  #                 position = position_jitter(width = 0.5, height = 0))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  xlab(label = "")+
  ylab(label = expression(pi))+
  ylim(c(0.5, 1))
```





## Comparison with the Welch's t-test (T-test)

```{r, fig.height = 6, fig.width = 8}
ggplot()+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), 
             linetype = "dashed", col = "darkgray")+
  geom_point(data = stats, col = "red", size = 2,
             aes(x = pmax, y = -log10(t.test.fdr.pvalue)))+
  geom_text_repel(data = stats[stats$pmax >= 0.8, ], 
                  aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                      label = gene_name), size = 4, 
                  min.segment.length = 0.1)+
  xlim(0.5, 1)+
  ylab(label = "-log10 (P-value) from t-test [FDR corrected]")+
  xlab(label = expression(pi))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```



### Outlier: IGHV5

```{r, fig.height = 5, fig.width = 8}
promising.genes <- unique(M$usage.data$gene_names)

ppc.gene <- M$ppc.data$ppc.gene
ppc.gene <- ppc.gene[ppc.gene$gene_name %in% promising.genes, ]

ggplot()+
  geom_errorbar(data = ppc.gene,
                aes(x = gene_name, ymin = ppc.L, 
                    ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = viz[viz$gene_name %in% promising.genes, ],
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 1.5, fill = "black",
             position = position_jitterdodge(jitter.width = 0.15, 
                                             jitter.height = 0, 
                                             dodge.width = 0.8))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")
```


### Outliers IGHV5 (original data)

```{r, fig.height = 4, fig.width = 7}
promising.genes <- "IGHV5"

ggplot(data = viz[viz$gene_name %in% promising.genes, ])+
  facet_wrap(facets = ~gene_name, ncol = 1, scales = "free_y")+
  geom_point(aes(x = sample_id, y = gene_usage_count, fill = condition, 
                 size = total/10^3), shape = 21)+
  theme_bw(base_size = 12)+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  theme(legend.position = "top")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_size_continuous(name = "N (10^3)", range = c(2, 6))+
  ylab(label = "Usage [count]")+
  xlab(label = '')+
  scale_y_log10()+
  annotation_logticks(base = 10, sides = "l")
```





## Comparison with the Wilcoxon signed-rank test (U-test)
No evidence of differential usage (at FDR level 0.05)

```{r, fig.height = 6, fig.width = 8}
ggplot()+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), 
             linetype = "dashed", col = "darkgray")+
  geom_point(data = stats, col = "red", size = 2,
             aes(x = pmax, y = -log10(u.test.fdr.pvalue)))+
  geom_text_repel(data = stats[stats$pmax >= 0.8, ], 
                  aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                      label = gene_name), size = 4, 
                  min.segment.length = 0.1)+
  xlim(0.5, 1)+
  ylab(label = "-log10 (P-value) from U-test [FDR corrected]")+
  xlab(label = expression(pi))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```







# Case Study III

The main purpose of using IgGeneUsage is to discover differential gene usage. 
However, the tool can be be used for all differential count analyses. In the 
third case study we explain how to detect differential usage of net CDR3 
sequence charge between repertoires belonging to two biological conditions. For 
this purpose we use CDR3 sequence data of human T-cells (TRB-chain) downloaded 
from VDJdb [^4]. 

Each CDR3 sequence is annotated to a specific viral epitope. Here we focus 
on the two viruses InfluenzaA and CMV which represent the two biological 
conditions. We consider the different data sources (publications) as different 
repertoires. To compute the net sequence charge, we consider the amino acids 
K, R and H as +1 charged, while D and E as -1 charged. Thus, we computed the 
net charge of a CDR3 sequence by adding up the individual residue charges. 

[^4]: https://vdjdb.cdr3.net/


## Input data

```{r}
data(CDR3_Epitopes, package = "IgGeneUsage")
```



```{r}
kable(x = head(CDR3_Epitopes), 
      row.names = FALSE)
```




## Data visualization

Lets look at the input data with ggplot2.

```{r, fig.height = 4, fig.width = 7}
# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition,
                         FUN = sum, data = CDR3_Epitopes)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = CDR3_Epitopes, y = total.usage,
             by = c("sample_id", "condition"),
             all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100

# visualize
ggplot(data = viz)+
  geom_point(aes(x = as.numeric(gene_name), 
                 y = gene_usage_pct, fill = condition, 
                 shape = condition), stroke = 0, size = 2, alpha = 0.5,
             position = position_jitterdodge(jitter.width = 0.15, 
                                             dodge.width = 0.5))+
  theme_bw(base_size = 12)+
  ylab(label = "Usage [%]")+
  xlab(label = 'Net Charge')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("orange", "#6666ff"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))+
  scale_x_continuous(breaks = -7:7, labels = -7:7)
```



## Analysis with IgGeneUsage

```{r}
M <- DGU(usage.data = CDR3_Epitopes,
         mcmc.warmup = 500,
         mcmc.steps = 1500,
         mcmc.chains = 2,
         mcmc.cores = 2,
         hdi.level = 0.95,
         adapt.delta = 0.95,
         max.treedepth = 13)
```




## Model checking

### MCMC sampling

  * divergences, tree-depth, energy

```{r}
rstan::check_hmc_diagnostics(M$glm)
```

  * Rhat and Neff

```{r, fig.height = 3, fig.wide = TRUE}
grid.arrange(rstan::stan_rhat(object = M$glm),
             rstan::stan_ess(object = M$glm),
             nrow = 1)
```



### Posterior predictive checks: repertoire-specific

```{r, fig.height = 8, fig.width = 8}
ggplot(data = M$ppc.data$ppc.repertoire)+
  facet_wrap(facets = ~sample_id, ncol = 4)+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", col = "darkgray")+
  geom_errorbar(aes(x = observed.count, y = ppc.count.mean, 
                    ymin = ppc.count.L, ymax = ppc.count.H), col = "darkgray")+
  geom_point(aes(x = observed.count, y = ppc.count.mean, fill = condition), 
             shape = 21, size = 2.5)+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()+
  xlab(label = "Observed usage [counts]")+
  ylab(label = "Predicted usage [counts]")
```



### Posterior predictive checks: overall differential usage

```{r, fig.height = 5, fig.width = 6}
ggplot(data = M$ppc.data$ppc.gene)+
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", col = "darkgray")+
  geom_errorbar(aes(x = observed.mean, ymin = ppc.L, ymax = ppc.H), 
                col = "darkgray")+
  geom_point(aes(x = observed.mean, y = ppc.mean, fill = condition), 
             shape = 21, size = 2)+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  xlab(label = "Observed usage [%]")+
  ylab(label = "Predicted usage [%]")
```



### Leave-one-out

```{r}
rstan::loo(x = M$glm)
```



## Results

```{r, fig.height = 4, fig.width = 6}
stats <- M$glm.summary
stats <- stats[order(abs(stats$effect_mean), decreasing = FALSE), ]
stats$gene_fac <- factor(x = stats$gene_name, levels = stats$gene_name)
stats <- merge(x= stats, y = M$test.stats, by = "gene_name")

ggplot()+
  geom_point(data = stats[stats$pmax < 0.95, ], aes(y = pmax, x = ''),
             position = position_jitter(width = 0.25, height = 0))+
  geom_text(data = stats[stats$pmax >= 0.95, ], size = 5, 
                  aes(y = pmax, x = '', label = gene_name), 
                  position = position_jitter(width = 0.44, height = 0))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  xlab(label = "")+
  ylab(label = expression(pi))+
  ylim(c(0.5, 1))
```



## Comparison with the Welch's t-test

```{r, fig.height=5, fig.width = 8}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), 
             linetype = "dashed", col = "darkgray")+
  geom_point(aes(x = pmax, y = -log10(t.test.fdr.pvalue)), 
             size = 1.5, col = "red")+
  geom_text_repel(aes(x = pmax, y = -log10(t.test.fdr.pvalue), 
                label = gene_name), size = 5)+
  xlim(0.5, 1)+
  ylab(label = "-log10 (P-value) from t-test [FDR corrected]")+
  xlab(label = expression(pi))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```



## Comparison with the Wilcoxon signed-rank test (U-test)

```{r, fig.height=5, fig.width = 8}
ggplot(data = stats)+
  geom_hline(yintercept = c(-log10(0.05), -log10(0.01)), 
             linetype = "dashed", col = "darkgray")+
  geom_point(aes(x = pmax, y = -log10(u.test.fdr.pvalue)), 
             size = 1.5, col = "red")+
  geom_text_repel(aes(x = pmax, y = -log10(u.test.fdr.pvalue), 
                label = gene_name), size = 5)+
  xlim(0.5, 1)+
  ylab(label = "-log10(p-value) from U-test [FDR corrected]")+
  xlab(label = expression(pi))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  scale_color_discrete(name = '')
```



### Net charge usage [in %] groups and posterior means (and 95% HDI of mean) 

```{r, fig.height=5, fig.width = 8}
promising.genes <- M$usage.data$gene_names

ppc.gene <- M$ppc.data$ppc.gene
ppc.gene <- ppc.gene[ppc.gene$gene_name %in% promising.genes, ]
ppc.gene$gene_name <- factor(x = ppc.gene$gene_name, levels = -5:6)

ggplot()+
  geom_errorbar(data = ppc.gene,
                aes(x = gene_name, ymin = ppc.L, 
                    ymax = ppc.H, col = condition),
                position = position_dodge(width = .8), width = 0.75)+
  geom_point(data = viz[viz$gene_name %in% promising.genes, ],
             aes(x = gene_name, y = gene_usage_pct, col = condition),
             shape = 21, size = 1.5, fill = "black",
             position = position_jitterdodge(jitter.width = 0.2, 
                                             jitter.height = 0, 
                                             dodge.width = 0.75))+
  theme_bw(base_size = 12)+
  theme(legend.position = "top")+
  ylab(label = "Gene usage [%]")+
  xlab(label = '')
```
