---
title: "Motivation for using zero-inflated beta-binomial model for regression"
author: "SK"
date: "June 25, 2019"
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Motivation for using zero-inflated beta-binomial model for regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = FALSE, 
                      warning = FALSE, message = FALSE)
```



```{r}
require(ggplot2)
require(gridExtra)
require(ggrepel)
require(rstan)
require(tidyr)
require(reshape2)
rstan_options(auto_write = TRUE)
```





# Introduction
When we analyze repertoires of health-challenged individuals, we are allowed
to sample a limited amount of cells from each patient. This leads to additional 
variability in the data, which is manifested by over-dispersion of gene usage 
within a biological condition, or by misdetection (zero-inflation) of genes 
which are systematically used at a low probability by the rearrangement process. 

Bayesian hierarcical models for ZIBB regression represent a solution to this 
problem. The ZIBB model describes the data using two components: 1) zero 
generating process that accounts for the excess zeros; 2) beta-binomial 
process that can also account for over-dispersion. In this vignette we show the 
pitfalls of not accounting for the over-dispersion while evaluating differential
gene usage.

The data used in this vignette is taken from Case Study I (explained in vignette 
'IgUsageCaseStudies'). We analyze the data with the following three models and
compare the results:

  * Binomial (B)
  * Beta-binomial (BB)
  * Zero-inflated beta-binomial (ZIBB)

See vignette 'ModelOVerview' for details about each model. To see an example 
where ZIBB is not preferred to BB, please see the following vignettes: 

  * 'ModelComparison_Alakazam'
  * 'ModelComparison_CDR3Charge'
  * 'ModelComparison_HIV'

```{r}
# compute
Mzibb <- get(load(file = "R/dev/ighv_hcv_zibb_model.RData"))
Mbb <- get(load(file = "R/dev/ighv_hcv_beta_binomial_model.RData"))
Mb <- get(load(file = "R/dev/ighv_hcv_binomial.RData"))
rm(M)


effect.comparsion <- data.frame(zibb = abs(Mzibb$glm.summary$effect_mean),
                                bb = abs(Mbb$glm.summary$effect_mean),
                                b = abs(Mb$glm.summary$effect_mean),
                                gene_name = Mzibb$usage.data$gene_names,
                                stringsAsFactors = FALSE)

effect.comparsion$delta.zibb.bb <- abs(effect.comparsion$zibb-effect.comparsion$bb)
effect.comparsion$rank.zibb.bb[order(
  effect.comparsion$delta.zibb.bb, decreasing = TRUE)] <- 1:nrow(effect.comparsion)

effect.comparsion$delta.zibb.b <- abs(effect.comparsion$zibb-effect.comparsion$b)
effect.comparsion$rank.zibb.b[order(
  effect.comparsion$delta.zibb.b, decreasing = TRUE)] <- 1:nrow(effect.comparsion)

effect.comparsion$delta.bb.b <- abs(effect.comparsion$bb-effect.comparsion$b)
effect.comparsion$rank.bb.b[order(
  effect.comparsion$delta.bb.b, decreasing = TRUE)] <- 1:nrow(effect.comparsion)


# get group PPC
Mzibb.group <- Mzibb$group.ppc$group.ppc
Mzibb.group$model <- "ZIBB"

Mbb.group <- Mbb$group.ppc$group.ppc
Mbb.group$model <- "BB"

Mb.group <- Mb$group.ppc$group.ppc
Mb.group$model <- "B"

group.stats <- rbind(Mzibb.group, Mbb.group, Mb.group)
rm(Mzibb.group, Mbb.group, Mb.group)
```



# Comparison of coefficients for differential gene usage 

Comparisons:

  * ZIBB vs BB
  * ZIBB vs B
  * BB vs B

Note that the binomial model is too optimistic, i.e. it over-estimates the 
coefficient of differnetial gene usage. This because the binomial model ignores 
the over-dispersion in the data. There is a lot of discordance between models
ZIBB and BB as well (many genes are shown far away from the diagnoal). Next, 
lets look at the 10 genes which are far away from the diagnoal in the comparison
between ZIBB and BB.

```{r, fig.wide = TRUE, fig.height=5}
grid.arrange(
  ggplot(data = effect.comparsion)+
    geom_point(aes(x = zibb, y = bb))+
    geom_text_repel(data = effect.comparsion[effect.comparsion$rank.zibb.bb <= 10, ],
                    aes(x = zibb, y = bb, label = gene_name), 
                    size = 3, min.segment.length = 0.1)+
    geom_abline(intercept = 0, slope = 1, col = "darkgray", linetype = "dashed")+
    theme_bw(base_size = 12)+
    xlab(label = "ZIBB")+
    ylab(label = "BB"),
  ggplot(data = effect.comparsion)+
    geom_point(aes(x = zibb, y = b))+
    geom_text_repel(data = effect.comparsion[effect.comparsion$rank.zibb.b <= 10, ],
                    aes(x = zibb, y = b, label = gene_name), 
                    size = 3, min.segment.length = 0.1)+
    geom_abline(intercept = 0, slope = 1, col = "darkgray", linetype = "dashed")+
    theme_bw(base_size = 12)+
    xlab(label = "ZIBB")+
    ylab(label = "B"),
  ggplot(data = effect.comparsion)+
    geom_point(aes(x = bb, y = b))+
    geom_text_repel(data = effect.comparsion[effect.comparsion$rank.bb.b <= 10, ],
                    aes(x = bb, y = b, label = gene_name), 
                    size = 3, min.segment.length = 0.1)+
    geom_abline(intercept = 0, slope = 1, col = "darkgray", linetype = "dashed")+
    geom_abline(intercept = 0, slope = 1, col = "darkgray", linetype = "dashed")+
    theme_bw(base_size = 12)+
    xlab(label = "BB")+
    ylab(label = "B"),
  nrow = 1)
```




# Reality Check
The discordant genes have gene usage which is inflated by zeros, i.e. the 
distribution of gene usage is made up of two components, namely a zero component 
and non-zero component. 

The models B and BB handle the data as originating from one component. Their 
resulting estimate of gene usage are a compromise between both components. The 
ZIBB model does not suffer from this problem and correctly estimates the mean
usage in such a case.

Noteable examples:

  * IGHV3-9
  * IGHV3-66
  * IGHV5-10-1

```{r, fig.wide = TRUE, fig.height = 5}
data("IGHV_HCV")

# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition, 
                         FUN = sum, data = IGHV_HCV)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = IGHV_HCV, y = total.usage, 
                  by = c("sample_id", "condition"), 
                  all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100


# interesting genes
interesting.genes <- effect.comparsion$gene_name[effect.comparsion$rank.zibb.bb <= 10]

# visualize
ggplot(data = viz[viz$gene_name %in% interesting.genes, ])+
  geom_point(aes(x = gene_name, y = gene_usage_pct, fill = condition, shape = condition), 
             alpha = 0.5, stroke = 0, size = 2, 
             position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.15))+
  geom_errorbar(data = group.stats[group.stats$gene_name %in% interesting.genes, ],
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, linetype = condition, col = model),
                position = position_dodge(width = 0.75), width = 0.35, size = 0.75)+
  theme_bw(base_size = 12)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top", axis.text.x = element_text(angle = 60, hjust = 1, vjust = 1))+
  scale_fill_manual(name = "Condition", values = c("darkgray", "black"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```



