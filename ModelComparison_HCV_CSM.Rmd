---
title: "Model Comparison (HCV CSM)"
author: "SK"
date: "June 25, 2019"
output: 
  html_document: 
    highlight: tango
    theme: journal
    toc: yes
---

```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = FALSE, 
                      warning = FALSE, message = FALSE)
```


```{r}
require(ggplot2)
require(ggforce)
require(gridExtra)
require(ggrepel)
source(file = "R/Util.R")
```



## Models

### M0: Zero-model Binomial regression
* $Y_{ij} \sim \operatorname{Binomial}(N_{i}, \theta_{ij})$
* $\theta_{ij} = \operatorname{logit^{-1}} (\alpha_{j} + \beta_{j} \cdot X_{i})$
* $\beta_{j} \sim \operatorname{Normal}(\hat{\beta}, \hat{\beta}_{\sigma})$
* $\alpha_{j} \sim \operatorname{Normal}(\hat{\alpha}, \hat{\alpha}_{\sigma})$
* $\hat{\beta} \sim \operatorname{Normal}(0, 5)$
* $\hat{\alpha} \sim \operatorname{Normal}(0, 20)$
* $\beta_{\sigma}, \hat{\alpha}_{\sigma} \sim \operatorname{Cauchy^{+}}(0, 3)$


### M1: Binomial regression
* $Y_{ij} \sim \operatorname{Binomial}(N_{i}, \theta_{ij})$
* $\theta_{ij} = \operatorname{logit^{-1}} (\alpha_{j} + \beta_{ij} \cdot X_{i})$
* $\beta_{ij} \sim \operatorname{Normal}(\gamma_{j}, \gamma_{\sigma})$
* $\gamma_{j} \sim \operatorname{Normal}(\hat{\gamma}, \hat{\gamma}_{\sigma})$
* $\alpha_{j} \sim \operatorname{Normal}(\hat{\alpha}, \hat{\alpha}_{\sigma})$
* $\hat{\gamma} \sim \operatorname{Normal}(0, 5)$
* $\hat{\alpha} \sim \operatorname{Normal}(0, 20)$
* $\gamma_{\sigma}, \hat{\gamma}_{\sigma}, \hat{\alpha}_{\sigma} \sim \operatorname{Cauchy^{+}}(0, 3)$

### M2: Zero-Inflated-Binomial (ZIB) regression
* cases for $Y_{ij}=$
* $0, \text{with } \pi_j$
* $\operatorname{Binomial}(N_{i}, \theta_{ij}), \text{with } 1-\pi_j$
* $\theta_{ij} = \operatorname{logit^{-1}} (\alpha_{j} + \beta_{ij} \cdot X_{i})$
* $\beta_{ij} \sim \operatorname{Normal}(\gamma_{j}, \gamma_{\sigma})$
* $\gamma_{j} \sim \operatorname{Normal}(\hat{\gamma}, \hat{\gamma}_{\sigma})$
* $\alpha_{j} \sim \operatorname{Normal}(\hat{\alpha}, \hat{\alpha}_{\sigma})$
* $\hat{\gamma} \sim \operatorname{Normal}(0, 5)$
* $\hat{\alpha} \sim \operatorname{Normal}(0, 20)$
* $\gamma_{\sigma}, \hat{\gamma}_{\sigma}, \hat{\alpha}_{\sigma} \sim \operatorname{Cauchy^{+}}(0, 3)$
* $\pi_j \sim \operatorname{Beta}(1, 1)$

### M3: Beta-binomial regression
* $Y_{ij} \sim \operatorname{Beta-Binomial}(N_{i}, \theta_{ij} \cdot \phi, (1 - \theta_{ij}) \cdot \phi)$
* $\theta_{ij} = \operatorname{logit^{-1}} (\alpha_{j} + \beta_{ij} \cdot X_{i})$
* $\beta_{ij} \sim \operatorname{Normal}(\gamma_{j}, \gamma_{\sigma})$
* $\gamma_{j} \sim \operatorname{Normal}(\hat{\gamma}, \hat{\gamma}_{\sigma})$
* $\alpha_{j} \sim \operatorname{Normal}(\hat{\alpha}, \hat{\alpha}_{\sigma})$
* $\hat{\gamma} \sim \operatorname{Normal}(0, 5)$
* $\hat{\alpha} \sim \operatorname{Normal}(0, 20)$
* $\gamma_{\sigma}, \hat{\gamma}_{\sigma}, \hat{\alpha}_{\sigma} \sim \operatorname{Cauchy^{+}}(0, 3)$
* $\phi \sim \operatorname{Gamma}(0.1, 0.1)$


```{r}
M0 <- get(load(file = "R/dev/ighv_hcv_zero_model.RData"))
M1 <- get(load(file = "R/dev/ighv_hcv_model.RData"))
M2 <- get(load(file = "R/dev/ighv_hcv_zib_multiz.RData"))
M3 <- get(load(file = "R/dev/ighv_hcv_beta_binomial_model.RData"))
# M4 <- get(load(file = "R/dev/ighv_hcv_zibb_model.RData"))
# M5 <- get(load(file = "R/dev/ighv_hcv_zmix_model.RData"))
rm(usage.hcv.csm, M)

M0$glm@model_name <- "M0"
M1$glm@model_name <- "M1"
M2$glm@model_name <- "M2"
M3$glm@model_name <- "M3"
# M4$glm@model_name <- "M4"
# M5$glm@model_name <- "M5"
```


## LOO


### M0

```{r}
print(loo::loo(loo::extract_log_lik(M0$glm)))
```


### M1

```{r}
print(loo::loo(loo::extract_log_lik(M1$glm)))
```


### M2

```{r}
print(loo::loo(loo::extract_log_lik(M2$glm)))
```


### M3

```{r}
print(loo::loo(loo::extract_log_lik(M3$glm)))
```


<!-- ### M4 -->

<!-- ```{r} -->
<!-- print(loo::loo(loo::extract_log_lik(M4$glm))) -->
<!-- ``` -->


<!-- ### M5 -->

<!-- ```{r} -->
<!-- print(loo::loo(loo::extract_log_lik(M5$glm))) -->
<!-- ``` -->



### Comparison

```{r}
loo::compare(loo::loo(loo::extract_log_lik(M0$glm)),
             loo::loo(loo::extract_log_lik(M1$glm)),
             loo::loo(loo::extract_log_lik(M2$glm)),
             loo::loo(loo::extract_log_lik(M3$glm)))
             # loo::loo(loo::extract_log_lik(M4$glm)),
             # loo::loo(loo::extract_log_lik(M5$glm)))

M0$glm <- NULL
M1$glm <- NULL
M2$glm <- NULL
M3$glm <- NULL
# M4$glm <- NULL
# M5$glm <- NULL
```


## PPC

```{r, fig.height=70, fig.width=12}
M0.ppc <- M0$ppc
M0.ppc$model <- "M0"
M1.ppc <- M1$ppc
M1.ppc$model <- "M1"
M2.ppc <- M2$ppc
M2.ppc$model <- "M2"
M3.ppc <- M3$ppc
M3.ppc$model <- "M3"
ppc <- rbind(M0.ppc, M1.ppc, M2.ppc, M3.ppc)
rm(M1.ppc, M0.ppc, M2.ppc, M3.ppc)

ppc$ppc.raw.mean <- as.numeric(ppc$ppc.raw.mean)

ggplot(data = ppc)+
  facet_grid(facets = gene_name~model)+
  geom_errorbar(aes(x = sample_id, y = ppc.pct.mean, 
                    ymin = ppc.pct.L, ymax = ppc.pct.H))+
  geom_point(aes(x = sample_id, y = raw.pct, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))
```




### M0

```{r, fig.height=6, fig.width=8}
ggplot(data = M0$ppc)+
  facet_wrap(facets = ~sample_id, ncol = 7)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw, y = ppc.raw.mean, 
                    ymin = ppc.raw.L, ymax = ppc.raw.H))+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()
```


### M1

```{r, fig.height=6, fig.width=8}
ggplot(data = M1$ppc)+
  facet_wrap(facets = ~sample_id, ncol = 7)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw, y = ppc.raw.mean, 
                    ymin = ppc.raw.L, ymax = ppc.raw.H))+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()
```


### M2

```{r, fig.height=6, fig.width=8}
ggplot(data = M2$ppc)+
  facet_wrap(facets = ~sample_id, ncol = 7)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw, y = ppc.raw.mean, 
                    ymin = ppc.raw.L, ymax = ppc.raw.H))+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()
```


### M3

```{r, fig.height=6, fig.width=8}
ggplot(data = M3$ppc)+
  facet_wrap(facets = ~sample_id, ncol = 7)+
  geom_abline(intercept = 0, slope = 1)+
  geom_errorbar(aes(x = raw, y = ppc.raw.mean, 
                    ymin = ppc.raw.L, ymax = ppc.raw.H))+
  geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+
  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_x_log10()+
  scale_y_log10()
```


<!-- ### M4 -->

<!-- ```{r, fig.height=6, fig.width=8} -->
<!-- ggplot(data = M4$ppc)+ -->
<!--   facet_wrap(facets = ~sample_id, ncol = 7)+ -->
<!--   geom_abline(intercept = 0, slope = 1)+ -->
<!--   geom_errorbar(aes(x = raw, y = ppc.raw.mean,  -->
<!--                     ymin = ppc.raw.L, ymax = ppc.raw.H))+ -->
<!--   geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+ -->
<!--   theme_bw(base_size = 9)+ -->
<!--   theme(legend.position = "top") -->
<!-- ``` -->


<!-- ### M5 -->

<!-- ```{r, fig.height=6, fig.width=8} -->
<!-- ggplot(data = M5$ppc)+ -->
<!--   facet_wrap(facets = ~sample_id, ncol = 7)+ -->
<!--   geom_abline(intercept = 0, slope = 1)+ -->
<!--   geom_errorbar(aes(x = raw, y = ppc.raw.mean,  -->
<!--                     ymin = ppc.raw.L, ymax = ppc.raw.H))+ -->
<!--   geom_point(aes(x = raw, y = ppc.raw.mean, fill = condition), shape = 21)+ -->
<!--   theme_bw(base_size = 9)+ -->
<!--   theme(legend.position = "top") -->
<!-- ``` -->




### Errors at a repertoire level
  * e[%] = |Yhat[%] - Y[%| or 
  * e[raw count] = |Yhat[count] - Y[count]| 

```{r, fig.height=2.5, fig.width=10}
grid.arrange(
  ggplot()+
    geom_sina(data = M0$ppc, aes(x = "M0 [%]", y = abs(raw.pct-ppc.pct.mean)),
              shape = 21, fill = "white")+
    geom_sina(data = M1$ppc, aes(x = "M1 [%]", y = abs(raw.pct-ppc.pct.mean)),
              shape = 21, fill = "white")+
    geom_sina(data = M2$ppc, aes(x = "M2", y = abs(raw.pct-ppc.pct.mean)),
              shape = 21, fill = "white")+
    geom_sina(data = M3$ppc, aes(x = "M3", y = abs(raw.pct-ppc.pct.mean)),
              shape = 21, fill = "white")+
    # geom_sina(data = M4$ppc, aes(x = "M4", y = abs(raw.pct-ppc.pct.mean)),
    #           shape = 21, fill = "white")+
    # geom_sina(data = M5$ppc, aes(x = "M5", y = abs(raw.pct-ppc.pct.mean)),
    #           shape = 21, fill = "white")+
    theme_bw(base_size = 9)+
    theme(legend.position = "top")+
    ylab(label = "e[%]")+
    xlab(label = "")+
    scale_y_log10(),
  ggplot()+
    geom_sina(data = M0$ppc, aes(x = "M0", y = abs(raw-ppc.raw.mean)),
              shape = 21, fill = "white")+
    geom_sina(data = M1$ppc, aes(x = "M1", y = abs(raw-ppc.raw.mean)),
              shape = 21, fill = "white")+
    geom_sina(data = M2$ppc, aes(x = "M2", y = abs(raw-ppc.raw.mean)),
              shape = 21, fill = "white")+
    geom_sina(data = M3$ppc, aes(x = "M3", y = abs(raw-ppc.raw.mean)),
              shape = 21, fill = "white")+
    # geom_sina(data = M4$ppc, aes(x = "M4", y = abs(raw-ppc.raw.mean)),
    #           shape = 21, fill = "white")+
    # geom_sina(data = M5$ppc, aes(x = "M5", y = abs(raw-ppc.raw.mean)),
    #           shape = 21, fill = "white")+
    theme_bw(base_size = 9)+
    theme(legend.position = "top")+
    ylab(label = "e [raw count]")+
    xlab(label = '')+
    scale_y_log10(),
  nrow = 1)
```


### Errors at a gene level
  * raw mean in gene&condition vs ppc mean in gene&condition
  
```{r, fig.height=6, fig.width=8}
grid.arrange(
  ggplot(data = M0$group.ppc$group.ppc)+
    geom_abline(intercept = 0, slope = 1)+
    geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
    geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
    theme_bw(base_size = 9)+
    theme(legend.position = "top")+
    ggtitle(label = "M0"),
  ggplot(data = M1$group.ppc$group.ppc)+
    geom_abline(intercept = 0, slope = 1)+
    geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
    geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
    theme_bw(base_size = 9)+
    theme(legend.position = "top")+
    ggtitle(label = "M1"),
  ggplot(data = M2$group.ppc$group.ppc)+
    geom_abline(intercept = 0, slope = 1)+
    geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
    geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
    theme_bw(base_size = 9)+
    theme(legend.position = "top")+
    ggtitle(label = "M2"),
  ggplot(data = M3$group.ppc$group.ppc)+
    geom_abline(intercept = 0, slope = 1)+
    geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
    geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
    theme_bw(base_size = 9)+
    theme(legend.position = "top")+
    ggtitle(label = "M3"),
  # ggplot(data = M4$group.ppc$group.ppc)+
  #   geom_abline(intercept = 0, slope = 1)+
  #   geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
  #   geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
  #   theme_bw(base_size = 9)+
  #   theme(legend.position = "top")+
  #   ggtitle(label = "M4"),
  # ggplot(data = M5$group.ppc$group.ppc)+
  #   geom_abline(intercept = 0, slope = 1)+
  #   geom_errorbar(aes(x = raw.M, ymin = ppc.L, ymax = ppc.H))+
  #   geom_point(aes(x = raw.M, y = ppc.M, fill = condition), shape = 21)+
  #   theme_bw(base_size = 9)+
  #   theme(legend.position = "top")+
  #   ggtitle(label = "M5"),
  nrow = 2)
```



```{r, fig.height=25, fig.width=8}
M0.group <- M0$group.ppc$group.ppc
M0.group$model <- "M0"
M1.group <- M1$group.ppc$group.ppc
M1.group$model <- "M1"
M2.group <- M2$group.ppc$group.ppc
M2.group$model <- "M2"
M3.group <- M3$group.ppc$group.ppc
M3.group$model <- "M3"

group <- rbind(M0.group, M1.group, M2.group, M3.group)
rm(M0.group, M1.group, M2.group, M3.group)

i <- M3$ppc

ggplot()+
  facet_wrap(facets = ~gene_name, ncol = 5, scales = "free_y")+
  geom_point(data = i, aes(x = "Y", y = ppc.pct.mean, fill = condition),
             shape = 21, stroke = 0, alpha = 0.5, size = 2,
             position = position_jitterdodge(jitter.width = 0.15,
                                             dodge.width = 0.85,
                                             jitter.height = 0))+
  geom_errorbar(data = group,
                aes(x = model, ymin = ppc.L,
                    ymax = ppc.H, linetype = condition, col = model),
                position = position_dodge(width = .8), width = 0.75)+

  theme_bw(base_size = 9)+
  theme(legend.position = "top")+
  scale_fill_manual(values = c("black", "darkgray"))
```

















