---
title: "Why do we use zero-inflated beta-binomial (ZIBB) regression?"
author: "SK"
date: "June 25, 2019"
output: 
  html_document: 
    highlight: tango
    theme: journal
    toc: yes
---


```{r setup, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = FALSE, 
                      warning = FALSE, message = FALSE)
```



```{r}
require(ggplot2)
require(gridExtra)
require(ggrepel)
require(rstan)
require(tidyr)
require(reshape2)
rstan_options(auto_write = TRUE)

source(file = "R/Util.R")
source(file = "R/Usage.R")
```





# Introduction
When we analyze repertoires of health-challenged individuals, we are allowed
to sample a limited amount of cells from each patient. This leads to additional 
variability in the data, which is manifested by over-dispersion of gene usage 
within a biological condition, or by misdetection (zero-inflation) of genes 
which are systematically used at a low probability by the rearrangement process. 
Bayesian hierarcical models for ZIBB regression are a solution to this problem. 
Here we show the pitfalls of not accounting for the overdispersion while 
performing differential gene usage analysis.

We data from from Case Study I (explained in vignette 'IgUsageCaseStudies'). We
analyze the data with ZIBB model and a Beta-binomial (BB) model.



# Case Studies
## Case Study I
The IgGeneUsage package comes with built-in datasets of gene usage. In the first 
case study we will evaluate disruptions in the IGHV-segment usage of class 
switched (CS) memory B-cells between HCV+ (N = 22) and healthy individuals 
(N = 7)[^1].

[^1]: Tucci, Felicia A., et al. "Biased IGH VDJ gene repertoire and clonal 
expansions in B cells of chronically hepatitis C virusâ€“infected individuals." 
Blood 131.5 (2018): 546-557.]



```{r}
Mzibb <- get(load(file = "R/dev/ighv_hcv_zibb_model.RData"))
Mbb <- get(load(file = "R/dev/ighv_hcv_beta_binomial_model.RData"))
Mb <- get(load(file = "R/dev/ighv_hcv_binomial.RData"))
rm(M)


effect.comparsion <- data.frame(zibb = abs(Mzibb$glm.summary$effect_mean),
                                bb = abs(Mbb$glm.summary$effect_mean),
                                b = abs(Mb$glm.summary$effect_mean),
                                gene_name = Mzibb$usage.data$gene_names,
                                stringsAsFactors = FALSE)

effect.comparsion$delta.zibb.bb <- abs(effect.comparsion$zibb-effect.comparsion$bb)
effect.comparsion$rank.zibb.bb[order(effect.comparsion$delta.zibb.bb, 
                                     decreasing = T)] <- 1:nrow(effect.comparsion)

effect.comparsion$delta.zibb.b <- abs(effect.comparsion$zibb-effect.comparsion$b)
effect.comparsion$rank.zibb.b[order(effect.comparsion$delta.zibb.b, 
                                    decreasing = T)] <- 1:nrow(effect.comparsion)

effect.comparsion$delta.bb.b <- abs(effect.comparsion$bb-effect.comparsion$b)
effect.comparsion$rank.bb.b[order(effect.comparsion$delta.bb.b, 
                                  decreasing = T)] <- 1:nrow(effect.comparsion)



# get group PPC
Mzibb.group <- Mzibb$group.ppc$group.ppc
Mzibb.group$model <- "ZIBB"

Mbb.group <- Mbb$group.ppc$group.ppc
Mbb.group$model <- "Beta-Binomial"

Mb.group <- Mb$group.ppc$group.ppc
Mb.group$model <- "Binomial"

group.stats <- rbind(Mzibb.group, Mbb.group, Mb.group)
rm(Mzibb.group, Mbb.group, Mb.group)
```


```{r, fig.width=8, fig.height=8}
grid.arrange(
  ggplot(data = effect.comparsion)+
    geom_point(aes(x = zibb, y = bb))+
    geom_text_repel(data = effect.comparsion[effect.comparsion$rank.zibb.bb <= 10, ],
                    aes(x = zibb, y = bb, label = gene_name), size = 2)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = effect.comparsion)+
    geom_point(aes(x = zibb, y = b))+
    geom_text_repel(data = effect.comparsion[effect.comparsion$rank.zibb.b <= 10, ],
                    aes(x = zibb, y = b, label = gene_name), size = 2)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  ggplot(data = effect.comparsion)+
    geom_point(aes(x = bb, y = b))+
    geom_text_repel(data = effect.comparsion[effect.comparsion$rank.bb.b <= 10, ],
                    aes(x = bb, y = b, label = gene_name), size = 2)+
    geom_abline(intercept = 0, slope = 1)+
    geom_abline(intercept = 0, slope = 1)+
    theme_bw(),
  nrow = 2)
```



```{r}
data("IGHV_HCV")
```


### Data visualization
Lets look at the input data with ggplot2.

```{r, fig.width=9, fig.height=4}
# we can compute the total number of rearrangements per sample
total.usage <- aggregate(gene_usage_count~sample_id+condition, 
                         FUN = sum, data = IGHV_HCV)
total.usage$total <- total.usage$gene_usage_count
total.usage$gene_usage_count <- NULL

# merge it with the original data
viz <- merge(x = IGHV_HCV, y = total.usage, 
                  by = c("sample_id", "condition"), 
                  all.x = TRUE)

# compute %
viz$gene_usage_pct <- viz$gene_usage_count/viz$total*100


# interesting genes
interesting.genes <- effect.comparsion$gene_name[effect.comparsion$rank.zibb.bb <= 10]

# visualize
ggplot(data = viz[viz$gene_name %in% interesting.genes, ])+
  geom_point(aes(x = gene_name, y = gene_usage_pct, fill = condition, shape = condition), 
             alpha = 0.5, stroke = 0, size = 2, 
             position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.15))+
  geom_errorbar(data = group.stats[group.stats$gene_name %in% interesting.genes, ],
                aes(x = gene_name, ymin = ppc.L, ymax = ppc.H, linetype = condition, col = model),
                position = position_dodge(width = .75), width = 0.75, size = .75)+
  theme_bw(base_size = 9)+
  ylab(label = "Usage [%]")+
  xlab(label = '')+
  theme(legend.position = "top",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.4))+
  scale_fill_manual(name = "Condition", values = c("gray", "black"))+
  scale_shape_manual(name = "Condition", values = c(21, 22))
```



